---
version: 2

# Plan ì •ì˜ - ì „ì²´ CI/CD íŒŒì´í”„ë¼ì¸
plan:
  project-key: DEMO                             # í”„ë¡œì íŠ¸ í‚¤ (ëŒ€ë¬¸ì)
  key: SPRING                                   # Plan í‚¤
  name: Spring Boot CI/CD Pipeline              # Plan í‘œì‹œ ì´ë¦„

# ì €ì¥ì†Œ ì—°ê²° ì„¤ì •
repositories:
  - my-repo:                                    # ì €ì¥ì†Œ ë³„ì¹­
      type: git                                 # Git íƒ€ì…
      url: https://github.com/devsyw/osci-backend.git # Git ì €ì¥ì†Œ URL
      branch: main                              # ê¸°ë³¸ ë¸Œëœì¹˜

# ë³€ìˆ˜ ì •ì˜ (ì „ì—­ ë³€ìˆ˜)
variables:
  DOCKER_REGISTRY: "docker.io"                  # Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
  APP_NAME: "myapp"                             # ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
  DOCKER_IMAGE: "${DOCKER_REGISTRY}/${APP_NAME}"

# Stage ì •ì˜ - ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ë‹¨ê³„ë“¤
stages:
  # Stage 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  - Build and Test:
      manual: false                             # ìë™ ì‹¤í–‰ (trueë©´ ìˆ˜ë™ ì‹¤í–‰)
      final: false                              # ìµœì¢… Stage ì•„ë‹˜
      jobs:
        - Build                                 # ì‹¤í–‰í•  Job ì´ë¦„

  # Stage 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - Docker Build:
      manual: false
      final: false
      jobs:
        - Docker Image Build

  # Stage 3: ê°œë°œ í™˜ê²½ ë°°í¬
  - Deploy to Dev:
      manual: false                             # ìë™ ë°°í¬
      final: false
      jobs:
        - Deploy Dev

  # Stage 4: ìš´ì˜ í™˜ê²½ ë°°í¬
  - Deploy to Production:
      manual: true                              # ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”
      final: true                               # ë§ˆì§€ë§‰ Stage
      jobs:
        - Deploy Prod

# Job ì •ì˜: Build
Build:
  key: BUILD
  tasks:
    # Task 1: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - checkout:
        force-clean-build: true                 # ë¹Œë“œ ì „ ì‘ì—… ë””ë ‰í† ë¦¬ ì™„ì „ ì‚­ì œ
        description: Gitì—ì„œ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ

    # Task 2: Gradle ë¹Œë“œ ì‹¤í–‰
    - script:
        interpreter: SHELL                      # Bash ì‰˜ ì‚¬ìš©
        scripts:
          - |-
            chmod +x ./gradlew
            ./gradlew clean package -DskipTests
            ls -la build/libs/
        description: Gradle ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰

    # Task 3: í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
#    - test-parser:
#        type: junit                             # JUnit í¬ë§· í…ŒìŠ¤íŠ¸ ê²°ê³¼
#        test-results: build/test-results/**/*.xml  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ìœ„ì¹˜
#        description: JUnit í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± ë° ë¦¬í¬íŒ…

    # Task 4: ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì²´í¬ (ì„ íƒì‚¬í•­)
#    - script:
#        interpreter: SHELL
#        scripts:
#          - |-
#            # JaCoCo ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
#            ./gradlew jacocoTestReport
#
#            # ì»¤ë²„ë¦¬ì§€ ìµœì†Œ ê¸°ì¤€ ì²´í¬ (ì˜ˆ: 80%)
#            ./gradlew jacocoTestCoverageVerification
#        description: ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ê²€ì¦

  # Artifact ì •ì˜ - ë‹¤ìŒ Job/Stageì—ì„œ ì‚¬ìš©í•  íŒŒì¼
  artifacts:
    - name: application-jar                     # Artifact ì´ë¦„
      pattern: build/libs/*.jar                 # íŒŒì¼ íŒ¨í„´
      shared: true                              # ë‹¤ë¥¸ Jobê³¼ ê³µìœ 
      required: true                            # í•„ìˆ˜ Artifact

  # Job ì‹¤í–‰ ìš”êµ¬ì‚¬í•­
  requirements:
    - system.builder.gradle.Gradle              # Gradle ì„¤ì¹˜ í•„ìš”
    - system.jdk.JDK 17                         # JDK 17 í•„ìš”

# Job ì •ì˜: Docker Image Build
Docker Image Build:
  key: DOCKER
  tasks:
    # Task 1: ì‘ì—… ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
    - clean

    # Task 2: ì´ì „ Stageì˜ JAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    - artifact-download:
        artifacts:
          - name: application-jar               # ë‹¤ìš´ë¡œë“œí•  Artifact
            destination: build/libs/            # ë‹¤ìš´ë¡œë“œ ìœ„ì¹˜

    # Task 3: Dockerfile ìƒì„± (ì¸ë¼ì¸)
    - script:
        interpreter: SHELL
        scripts:
          - |-
            # Dockerfile ë™ì  ìƒì„±
            cat > Dockerfile << 'EOF'
            FROM eclipse-temurin:17-jre-alpine
            
            # ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
            WORKDIR /app
            
            # JAR íŒŒì¼ ë³µì‚¬
            COPY build/libs/*.jar app.jar
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸ ë…¸ì¶œ
            EXPOSE 8080
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëª…ë ¹
            ENTRYPOINT ["java", "-jar", "app.jar"]
            EOF
        description: Dockerfile ìƒì„±

    # Task 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    - script:
        interpreter: SHELL
        scripts:
          - |-
            # ë¹Œë“œ ë²ˆí˜¸ë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
            IMAGE_TAG="${bamboo.buildNumber}"
            
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            docker build \
              -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
              -t ${DOCKER_IMAGE}:latest \
              .
            
            # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
            docker images | grep ${APP_NAME}
            
            # (ì„ íƒ) ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
            echo "ì´ë¯¸ì§€ í¬ê¸°: $(docker images ${DOCKER_IMAGE}:${IMAGE_TAG} --format '{{.Size}}')"
        description: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê¹…

    # Task 5: Docker ì´ë¯¸ì§€ í‘¸ì‹œ (ì„ íƒì‚¬í•­)
    - script:
        interpreter: SHELL
        scripts:
          - |-
            # Docker Hub ë¡œê·¸ì¸ (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
            echo ${bamboo.DOCKER_PASSWORD} | docker login -u ${bamboo.DOCKER_USERNAME} --password-stdin
            
            # ì´ë¯¸ì§€ í‘¸ì‹œ
            docker push ${DOCKER_IMAGE}:${bamboo.buildNumber}
            docker push ${DOCKER_IMAGE}:latest
            
            # ë¡œê·¸ì•„ì›ƒ
            docker logout
        description: Docker ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ

  requirements:
    - system.docker.executable                  # Docker ëª…ë ¹ì–´ ì‚¬ìš© ê°€ëŠ¥í•´ì•¼ í•¨

# Job ì •ì˜: Deploy Dev
Deploy Dev:
  key: DEPLOY_DEV
  tasks:
    - clean

    # Docker Composeë¥¼ ì´ìš©í•œ ë°°í¬
    - script:
        interpreter: SHELL
        scripts:
          - |-
            # docker-compose.dev.yml ìƒì„±
            cat > docker-compose.dev.yml << 'EOF'
            version: '3.8'
            services:
              app:
                image: ${DOCKER_IMAGE}:${bamboo.buildNumber}
                container_name: myapp-dev
                ports:
                  - "8080:8080"
                environment:
                  - SPRING_PROFILES_ACTIVE=dev
                  - DATABASE_URL=jdbc:postgresql://dev-db:5432/myapp
                restart: always
            EOF
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker-compose -f docker-compose.dev.yml down || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose -f docker-compose.dev.yml up -d
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            for i in {1..12}; do
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
                exit 0
              fi
              echo "ì¬ì‹œë„ $i/12..."
              sleep 5
            done
            
            echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨"
            docker-compose -f docker-compose.dev.yml logs
            exit 1
        description: ê°œë°œ í™˜ê²½ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬

  requirements:
    - system.docker.executable

# Job ì •ì˜: Deploy Prod
Deploy Prod:
  key: DEPLOY_PROD
  tasks:
    - clean

    # Blue-Green ë°°í¬ ì „ëµ
    - script:
        interpreter: SHELL
        scripts:
          - |-
            #!/bin/bash
            set -e  # ì—ëŸ¬ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìƒ‰ìƒ í™•ì¸
            CURRENT_COLOR=$(docker ps --filter "name=myapp-prod" --format "{{.Names}}" | grep -o 'blue\|green' | head -1)
            
            # ìƒˆë¡œ ë°°í¬í•  ìƒ‰ìƒ ê²°ì •
            if [ "$CURRENT_COLOR" = "blue" ]; then
              NEW_COLOR="green"
              OLD_COLOR="blue"
              NEW_PORT="8081"
            else
              NEW_COLOR="blue"
              OLD_COLOR="green"
              NEW_PORT="8080"
            fi
            
            echo "ğŸš€ Blue-Green ë°°í¬ ì‹œì‘"
            echo "í˜„ì¬ ì»¬ëŸ¬: $OLD_COLOR â†’ ìƒˆ ì»¬ëŸ¬: $NEW_COLOR"
            
            # 1. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "1ï¸âƒ£ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker run -d \
              --name myapp-prod-${NEW_COLOR} \
              -p ${NEW_PORT}:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DATABASE_URL=jdbc:postgresql://prod-db:5432/myapp \
              --restart always \
              ${DOCKER_IMAGE}:${bamboo.buildNumber}
            
            # 2. í—¬ìŠ¤ì²´í¬
            echo "2ï¸âƒ£ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘..."
            sleep 15  # ì´ˆê¸° ì‹œì‘ ëŒ€ê¸°
            
            for i in {1..10}; do
              if curl -f http://localhost:${NEW_PORT}/actuator/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹¤í–‰"
                docker stop myapp-prod-${NEW_COLOR}
                docker rm myapp-prod-${NEW_COLOR}
                exit 1
              fi
              echo "ì¬ì‹œë„ $i/10..."
              sleep 3
            done
            
            # 3. ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
            echo "3ï¸âƒ£ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
            RESPONSE=$(curl -s http://localhost:${NEW_PORT}/api/health)
            if [[ $RESPONSE != *"UP"* ]]; then
              echo "âŒ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
              docker stop myapp-prod-${NEW_COLOR}
              docker rm myapp-prod-${NEW_COLOR}
              exit 1
            fi
            
            # 4. íŠ¸ë˜í”½ ì „í™˜ (Nginx ì„¤ì • ë³€ê²½ - ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
            echo "4ï¸âƒ£ íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
            # ì—¬ê¸°ì„œ ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • ë³€ê²½
            # ì˜ˆ: Nginx upstream ë³€ê²½, AWS ALB íƒ€ê²Ÿ ê·¸ë£¹ ë³€ê²½ ë“±
            
            # 5. ì´ì „ ì»¨í…Œì´ë„ˆ ì œê±°
            echo "5ï¸âƒ£ ì´ì „ ì»¨í…Œì´ë„ˆ ì œê±° ì¤‘..."
            sleep 30  # ì—°ê²° ì™„ì „íˆ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            docker stop myapp-prod-${OLD_COLOR} || true
            docker rm myapp-prod-${OLD_COLOR} || true
            
            echo "âœ… Blue-Green ë°°í¬ ì™„ë£Œ!"
            echo "ìƒˆ ë²„ì „: ${bamboo.buildNumber} (${NEW_COLOR})"
        description: Blue-Green ë°°í¬ ì „ëµìœ¼ë¡œ ìš´ì˜ ë°°í¬

    # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - script:
        interpreter: SHELL
        scripts:
          - |-
            # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            curl -X POST ${bamboo.SLACK_WEBHOOK_URL} \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"âœ… ìš´ì˜ ë°°í¬ ì™„ë£Œ\",
                \"attachments\": [{
                  \"color\": \"good\",
                  \"fields\": [
                    {\"title\": \"ë¹Œë“œ\", \"value\": \"#${bamboo.buildNumber}\", \"short\": true},
                    {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"${bamboo.planRepository.branch}\", \"short\": true}
                  ]
                }]
              }"
        description: ë°°í¬ ì™„ë£Œ ì•Œë¦¼

  requirements:
    - system.docker.executable

# ë¸Œëœì¹˜ ìë™ ìƒì„± ì„¤ì •
branches:
  create: for-pull-request                     # PR ìƒì„±ì‹œ ë¸Œëœì¹˜ Plan ìë™ ìƒì„±
  delete:
    after-deleted-days: 7                       # ë¸Œëœì¹˜ ì‚­ì œ 7ì¼ í›„ Plan ì‚­ì œ
    after-inactive-days: 30                     # 30ì¼ ë¹„í™œì„±ì‹œ Plan ì‚­ì œ
  integration:
    push-on-success: false                      # ë¹Œë“œ ì„±ê³µì‹œ integration ë¸Œëœì¹˜ë¡œ ìë™ ë¨¸ì§€ ì•ˆí•¨
    merge-from: main                            # main ë¸Œëœì¹˜ì—ì„œ ë¨¸ì§€

# ì•Œë¦¼ ì„¤ì •
notifications:
  - events:
      - plan-completed                          # ë¹Œë“œ ì™„ë£Œì‹œ
      - plan-failed                             # ë¹Œë“œ ì‹¤íŒ¨ì‹œ
    recipients:
      - committers                              # ì»¤ë°‹í•œ ì‚¬ëŒì—ê²Œ ì•Œë¦¼
      - watchers                                # Planì„ watchí•˜ëŠ” ì‚¬ëŒì—ê²Œ ì•Œë¦¼

# Plan ê¶Œí•œ ì„¤ì •
plan-permissions:
  - users:
      - admin                                   # ê´€ë¦¬ì
    permissions:
      - view                                    # ì¡°íšŒ ê¶Œí•œ
      - edit                                    # ìˆ˜ì • ê¶Œí•œ
      - build                                   # ë¹Œë“œ ì‹¤í–‰ ê¶Œí•œ
      - clone                                   # ë³µì œ ê¶Œí•œ
      - admin                                   # ê´€ë¦¬ì ê¶Œí•œ
  - groups:
      - developers                              # ê°œë°œì ê·¸ë£¹
    permissions:
      - view
      - build